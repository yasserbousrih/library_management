<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Article Details</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"/>
  {% include "templates/includes/design-system.html" %}
  <style>
    /* Article Detail Page - Modern Design */
    .article-page-main { 
      max-width: 1000px; 
      margin: 0 auto; 
      padding: var(--space-16) var(--space-6); 
    }
    
    .article-hero {
      background: white;
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      margin-bottom: var(--space-8);
      position: relative;
    }
    
    .article-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
    }
    
    .article-header {
      padding: var(--space-12);
      text-align: center;
      position: relative;
    }
    
    .article-img-holder { 
      margin-bottom: var(--space-8);
      display: flex;
      justify-content: center;
    }
    
    .article-detail-img { 
      width: 300px;
      height: 400px;
      object-fit: cover;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      transition: all var(--transition-normal);
    }
    
    .article-detail-img:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-2xl);
    }
    
    .article-placeholder-img {
      width: 300px;
      height: 400px;
      background: linear-gradient(135deg, var(--neutral-100) 0%, var(--neutral-200) 100%);
      border: 2px dashed var(--neutral-300);
      border-radius: var(--radius-xl);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      box-shadow: var(--shadow-lg);
    }
    
    .article-detail-title { 
      font-size: var(--font-size-4xl);
      font-weight: 800;
      color: var(--neutral-900);
      margin-bottom: var(--space-4);
      line-height: 1.2;
    }
    
    .article-meta { 
      background: var(--neutral-50);
      border: 1px solid var(--neutral-200);
      border-radius: var(--radius-xl);
      padding: var(--space-8);
      margin-bottom: var(--space-8);
      box-shadow: var(--shadow-sm);
    }
    
    .article-meta > div { 
      margin-bottom: var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      font-size: var(--font-size-lg);
    }
    
    .article-meta > div:last-child {
      margin-bottom: 0;
    }
    
    .article-meta i {
      color: var(--primary-600);
      font-size: var(--font-size-xl);
      width: 24px;
    }
    
    .article-status-badge { 
      background: var(--success-50);
      color: var(--success-600);
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-full);
      font-weight: 600;
      font-size: var(--font-size-sm);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .article-description { 
      background: white;
      border: 1px solid var(--neutral-200);
      border-radius: var(--radius-xl);
      padding: var(--space-8);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--space-8);
    }
    
    .article-description h5 { 
      font-size: var(--font-size-xl);
      font-weight: 600;
      color: var(--neutral-900);
      margin-bottom: var(--space-4);
    }
    
    .article-description p {
      color: var(--neutral-700);
      line-height: 1.7;
      font-size: var(--font-size-lg);
    }
    
    .rent-section {
      background: white;
      border: 1px solid var(--neutral-200);
      border-radius: var(--radius-xl);
      padding: var(--space-8);
      box-shadow: var(--shadow-sm);
      text-align: center;
    }
    
    .rent-section h4 {
      font-size: var(--font-size-2xl);
      font-weight: 600;
      color: var(--neutral-900);
      margin-bottom: var(--space-4);
    }
    
    .rent-section p {
      color: var(--neutral-600);
      margin-bottom: var(--space-6);
      font-size: var(--font-size-lg);
    }
    
    .rent-form {
      max-width: 400px;
      margin: 0 auto;
    }
    
    .form-group {
      margin-bottom: var(--space-6);
      text-align: left;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      color: var(--neutral-700);
      margin-bottom: var(--space-2);
      font-size: var(--font-size-sm);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .form-control {
      width: 100%;
      padding: var(--space-4);
      border: 1px solid var(--neutral-300);
      border-radius: var(--radius-lg);
      font-size: var(--font-size-base);
      transition: all var(--transition-fast);
      background: white;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px var(--primary-100);
    }
    
    .btn-rent {
      background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
      color: white;
      border: none;
      padding: var(--space-4) var(--space-8);
      border-radius: var(--radius-full);
      font-size: var(--font-size-lg);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-normal);
      box-shadow: var(--shadow-md);
      width: 100%;
    }
    
    .btn-rent:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-800) 100%);
    }
    
    .btn-rent:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      color: var(--neutral-600);
      text-decoration: none;
      font-weight: 500;
      margin-bottom: var(--space-8);
      transition: color var(--transition-fast);
    }
    
    .back-link:hover {
      color: var(--primary-600);
    }
    
    .loading-state {
      text-align: center;
      padding: var(--space-16);
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--neutral-200);
      border-top: 4px solid var(--primary-600);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--space-4);
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: var(--neutral-600);
      font-size: var(--font-size-lg);
    }
    
    .empty-state {
      text-align: center;
      padding: var(--space-16) var(--space-8);
      background: white;
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--neutral-200);
    }
    
    .empty-state-icon {
      width: 80px;
      height: 80px;
      background: var(--neutral-100);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto var(--space-6);
      color: var(--neutral-400);
      font-size: var(--font-size-4xl);
    }
    
    .empty-state h3 {
      font-size: var(--font-size-2xl);
      font-weight: 600;
      color: var(--neutral-900);
      margin-bottom: var(--space-3);
    }
    
    .empty-state p {
      color: var(--neutral-600);
      margin-bottom: var(--space-6);
      font-size: var(--font-size-lg);
    }
    
    .btn-browse {
      background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
      color: white;
      text-decoration: none;
      padding: var(--space-4) var(--space-8);
      border-radius: var(--radius-full);
      font-weight: 600;
      transition: all var(--transition-normal);
      box-shadow: var(--shadow-md);
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .btn-browse:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-800) 100%);
      color: white;
    }
    
    @media (max-width: 768px) {
      .article-page-main {
        padding: var(--space-8) var(--space-4);
      }
      
      .article-detail-title {
        font-size: var(--font-size-3xl);
      }
      
      .article-detail-img,
      .article-placeholder-img {
        width: 250px;
        height: 350px;
      }
      
      .article-header {
        padding: var(--space-8);
      }
    }
  </style>
</head>
<body>
  {% include "templates/includes/navbar.html" %}
  {% include "templates/includes/toast.html" %}
  
<div class="article-page-main">
    <a href="/articles-page" class="back-link">
      <i class="bi bi-arrow-left"></i>
      Back to Articles
    </a>

    <!-- Loading state -->
    <div id="loading-state" class="loading-state">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading article details...</div>
    </div>

    <!-- Article content -->
    <div id="article-content" style="display: none;">
      <div class="article-hero">
        <div class="article-header">
          <div id="article-image-container" class="article-img-holder">
            <!-- Image will be loaded here -->
          </div>
          <h1 id="article-title" class="article-detail-title">Loading...</h1>
  </div>
  
    <div class="article-meta">
          <div>
            <i class="bi bi-person"></i>
            <strong>Author:</strong> <span id="article-author">Loading...</span>
          </div>
          <div>
            <i class="bi bi-building"></i>
            <strong>Publisher:</strong> <span id="article-publisher">Loading...</span>
          </div>
          <div>
            <i class="bi bi-upc-scan"></i>
            <strong>ISBN:</strong> <span id="article-isbn">Loading...</span>
          </div>
      <div>
            <i class="bi bi-check-circle"></i>
        <strong>Status:</strong>
            <span class="article-status-badge">Available</span>
      </div>
    </div>

        <div id="article-description" class="article-description" style="display: none;">
          <h5>Description</h5>
          <p id="article-description-text"></p>
      </div>

        <div class="rent-section">
          <h4>Rent This Article</h4>
          <p>Click the button below to rent this article for <span id="rental-period-display">Loading...</span> days</p>
          
          <button type="button" class="btn-rent" id="rentBtn">
            <i class="bi bi-cart-plus me-2"></i>
            Rent Article
            </button>
        </div>
        </div>
    </div>

    <!-- Error state -->
    <div id="error-state" class="empty-state" style="display: none;">
      <div class="empty-state-icon">
        <i class="bi bi-exclamation-triangle"></i>
      </div>
      <h3>Article Not Found</h3>
      <p>The article you're looking for doesn't exist or has been removed.</p>
      <a href="/articles-page" class="btn-browse">
        <i class="bi bi-arrow-left"></i>
        Back to Articles
    </a>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentArticle = null;
    let librarySettings = null;

    // Get article name from URL parameter
    function getArticleName() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('article_name');
    }

    // Load library settings
    async function loadLibrarySettings() {
        try {
            console.log('🔍 DEBUG: Loading library settings...');
            const response = await fetch('/api/method/library_management.api.get_library_settings');
            const result = await response.json();
            
            if (result.message && result.message.success) {
                librarySettings = result.message;
                console.log('🔍 DEBUG: Library settings loaded:', librarySettings);
            } else {
                console.log('🔍 DEBUG: Using default library settings');
                librarySettings = {
                    loan_period: 14,
                    max_articles_per_user: 3
                };
            }
        } catch (error) {
            console.error('🔍 DEBUG: Error loading library settings:', error);
            librarySettings = {
                loan_period: 14,
                max_articles_per_user: 3
            };
        }
    }

    // Check if user is logged in
    function isLoggedIn() {
      return document.cookie.split(';').some(cookie => cookie.trim().startsWith('user_id='));
    }

    // Get CSRF token
    function getCSRFToken() {
      const metaTag = document.querySelector('meta[name="csrf-token"]');
      return metaTag ? metaTag.getAttribute('content') : null;
    }

    // Show toast notification
    function showToast(message, type = 'info', duration = 3000) {
      const toastContainer = document.getElementById('toast-container') || createToastContainer();
      
        const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <div class="toast-content">
          <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
          <span>${message}</span>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, duration);
    }

    function createToastContainer() {
      const container = document.createElement('div');
      container.id = 'toast-container';
      container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 999999; pointer-events: none;';
      document.body.appendChild(container);
      return container;
    }

    // Load article details
    async function loadArticleDetails() {
      const articleName = getArticleName();
      console.log('🔍 DEBUG: Looking for article:', articleName);
      
      if (!articleName) {
        console.log('🔍 DEBUG: No article name found in URL');
        showErrorState();
        return;
      }

      try {
        // Use the working get_articles API
        console.log('🔍 DEBUG: Using get_articles API to find article:', articleName);
        const response = await fetch('/api/method/library_management.api.get_articles');
        
        const result = await response.json();
        console.log('🔍 DEBUG: Full API response:', result);
        console.log('🔍 DEBUG: Response structure:', {
          hasMessage: !!result.message,
          messageType: typeof result.message,
          messageContent: result.message,
          hasSuccess: result.message ? !!result.message.success : false,
          successValue: result.message ? result.message.success : 'N/A',
          hasData: result.message ? !!result.message.data : false,
          dataContent: result.message ? result.message.data : 'N/A'
        });
        
        // More detailed debugging
        console.log('🔍 DEBUG: Full message object:', result.message);
        if (result.message && result.message.data) {
          console.log('🔍 DEBUG: Data type:', typeof result.message.data);
          console.log('🔍 DEBUG: Is array:', Array.isArray(result.message.data));
          console.log('🔍 DEBUG: Data length:', result.message.data ? result.message.data.length : 'N/A');
          console.log('🔍 DEBUG: First few items:', result.message.data ? result.message.data.slice(0, 3) : 'N/A');
        }
        
        // Handle get_articles API response - check for both 'data' and 'articles' fields
        let articles = null;
        if (result.message && result.message.success) {
          if (result.message.data && Array.isArray(result.message.data)) {
            articles = result.message.data;
            console.log('🔍 DEBUG: Using result.message.data');
          } else if (result.message.articles && Array.isArray(result.message.articles)) {
            articles = result.message.articles;
            console.log('🔍 DEBUG: Using result.message.articles');
          }
        }
        
        if (articles) {
          console.log('🔍 DEBUG: Found articles list, searching for:', articleName);
          console.log('🔍 DEBUG: Available articles:', articles.map(a => ({ name: a.name, title: a.title })));
          console.log('🔍 DEBUG: Article name we are looking for:', `"${articleName}"`);
          console.log('🔍 DEBUG: Article name type:', typeof articleName);
          console.log('🔍 DEBUG: Article name length:', articleName ? articleName.length : 'N/A');
          
          // Find the specific article
          let article = articles.find(a => a.name === articleName);
          console.log('🔍 DEBUG: Exact match result:', article);
          
          if (!article) {
            // Try case-insensitive match
            article = articles.find(a => a.name.toLowerCase() === articleName.toLowerCase());
            console.log('🔍 DEBUG: Case-insensitive match result:', article);
          }
          
          if (!article) {
            // Try matching by title
            article = articles.find(a => a.title && a.title.toLowerCase() === articleName.toLowerCase());
            console.log('🔍 DEBUG: Title match result:', article);
          }
          
          if (article) {
            console.log('🔍 DEBUG: Found article:', article);
            currentArticle = article;
            displayArticle(article);
          } else {
            console.log('🔍 DEBUG: Article not found in articles list');
            console.log('🔍 DEBUG: Available article names:', articles.map(a => a.name));
            console.log('🔍 DEBUG: Available article titles:', articles.map(a => a.title));
            console.log('🔍 DEBUG: Looking for exact match in names:', articles.filter(a => a.name === articleName));
            console.log('🔍 DEBUG: Looking for exact match in titles:', articles.filter(a => a.title === articleName));
            showErrorState();
          }
        } else {
          console.log('🔍 DEBUG: API call failed or unexpected response structure:', result);
          console.log('🔍 DEBUG: Checking what we actually got...');
          console.log('🔍 DEBUG: result.message exists:', !!result.message);
          console.log('🔍 DEBUG: result.message.success:', result.message ? result.message.success : 'N/A');
          console.log('🔍 DEBUG: result.message.data exists:', result.message ? !!result.message.data : 'N/A');
          console.log('🔍 DEBUG: result.message.articles exists:', result.message ? !!result.message.articles : 'N/A');
          console.log('🔍 DEBUG: result.message.data is array:', result.message && result.message.data ? Array.isArray(result.message.data) : 'N/A');
          console.log('🔍 DEBUG: result.message.articles is array:', result.message && result.message.articles ? Array.isArray(result.message.articles) : 'N/A');
          console.log('🔍 DEBUG: Available fields in result.message:', result.message ? Object.keys(result.message) : 'N/A');
          showErrorState();
        }
      } catch (error) {
        console.error('🔍 DEBUG: Error loading article:', error);
        showErrorState();
      }
    }

    // Display article data
    function displayArticle(article) {
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('article-content').style.display = 'block';
      
      // Update title
      document.getElementById('article-title').textContent = article.title || article.name;
      document.title = `${article.title || article.name} | Article Details`;
      
      // Update meta information
      document.getElementById('article-author').textContent = article.author || 'Not specified';
      document.getElementById('article-publisher').textContent = article.publisher || 'Not specified';
      document.getElementById('article-isbn').textContent = article.isbn || 'Not specified';
      
      // Update description
      if (article.description) {
        document.getElementById('article-description-text').textContent = article.description;
        document.getElementById('article-description').style.display = 'block';
      }
      
      // Update rental period display from library settings
      if (librarySettings && librarySettings.loan_period) {
        const rentalPeriodDisplay = document.getElementById('rental-period-display');
        rentalPeriodDisplay.textContent = librarySettings.loan_period;
        
        console.log('🔍 DEBUG: Set rental period display to:', librarySettings.loan_period);
      }
      
      // Update image (since image field doesn't exist in database, always show placeholder)
      const imageContainer = document.getElementById('article-image-container');
      imageContainer.innerHTML = `
        <div class="article-placeholder-img">
          <i class="bi bi-book" style="font-size: 3rem; color: var(--neutral-400);"></i>
          <p style="margin-top: 0.5rem; color: var(--neutral-500); font-size: 0.9rem;">No image available</p>
        </div>
      `;
    }

    // Show error state
    function showErrorState() {
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('error-state').style.display = 'block';
    }

    // Handle rent button click
    document.getElementById('rentBtn').addEventListener('click', async function(e) {
            e.preventDefault();
      
      if (!currentArticle) {
        showToast('Article not loaded', 'error', 3000);
        return;
      }
      
      if (!isLoggedIn()) {
        showToast('Please log in to rent articles', 'error', 5000);
        setTimeout(() => {
          window.location.href = '/login';
        }, 2000);
        return;
      }

      const rentBtn = document.getElementById('rentBtn');
      const originalText = rentBtn.innerHTML;
      
            rentBtn.disabled = true;
      rentBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
      
      try {
        // Use rental period from library settings
        const rentalDays = librarySettings ? librarySettings.loan_period : 14;
        const csrfToken = getCSRFToken();
        
        const headers = { 'Content-Type': 'application/json' };
        if (csrfToken && csrfToken !== 'None') {
          headers['X-Frappe-CSRF-Token'] = csrfToken;
        }
        
        const response = await fetch('/api/method/library_management.api.rent_article', {
                    method: 'POST',
          headers: headers,
          body: JSON.stringify({
            article: currentArticle.name,
            rental_days: rentalDays
          })
        });
                
                const result = await response.json();
                
                if (result.message && result.message.success) {
          showToast('Article rented successfully!', 'success', 3000);
                    setTimeout(() => { 
                        window.location.href = '/my-articles'; 
          }, 2000);
                } else {
          const errorMsg = result.message ? result.message.message || result.message : 'Failed to rent article';
          showToast(errorMsg, 'error', 5000);
                }
            } catch (error) {
        console.error('Rent article error:', error);
        showToast('Network error. Please try again.', 'error', 5000);
            } finally {
                rentBtn.disabled = false;
        rentBtn.innerHTML = originalText;
      }
    });

    // Load article details when page loads
    document.addEventListener('DOMContentLoaded', async function() {
      await loadLibrarySettings();
      loadArticleDetails();
});
</script>
</body>
</html>