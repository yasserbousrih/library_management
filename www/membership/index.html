<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Library Membership</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {background: #f9f9fb; font-family: system-ui, 'Segoe UI', Arial, sans-serif;}
    .membership-page {padding: 2rem; max-width: 900px; margin: 0 auto;}
    .page-header {text-align: center; margin-bottom: 2rem;}
    .page-header h1 {font-size: 2.5rem; margin-bottom: 0.5rem; font-weight: 700; color: #222;}
    .membership-summary {font-size: 1.1rem; color: #6c757d;}
    .membership-list {margin-top: 0;}
    .membership-grid {display: grid; grid-template-columns: 1fr; gap: 2rem; width: 100%;}
    .membership-card {width: 100%; border: 1px solid #e3e5ea; border-radius: 1rem; background: #fff; box-shadow: 0 4px 24px rgba(0,0,0,0.08); display: flex; flex-direction: column; min-width: 0; padding-bottom: 0.5rem;}
    .membership-card:hover {transform: translateY(-3px) scale(1.01); box-shadow: 0 8px 32px rgba(0,0,0,0.12);}
    .card-header {padding: 1.1rem 1.5rem 0.4rem 1.5rem; border-bottom: 1px solid #f2f3f6; background: none;}
    .card-header h4 {font-size: 1.25rem; font-weight: 600; color: #283048;}
    .card-body {padding: 1.2rem 1.5rem 1rem 1.5rem;}
    .status-badge {display: inline-block; padding: 0.3em 1.2em; font-size: 1rem; font-weight: 600; border-radius: 1.2em; color: #fff; background: #2876ff;}
    .status-badge.expired {background: #adb5bd;}
    .membership-item {font-size:1rem; color: #495057; margin-bottom: 0.3em;}
    .divider {height: 1px; margin: 1.1em 0; background: #f0f1f4; border: none;}
    .alert {position: relative; padding: 0.85rem 1.25rem; margin-bottom: 1.2rem; border: 1px solid transparent; border-radius: 0.38rem; font-size: 1rem;}
    .alert-info {color: #1c7382; background-color: #e6f6fa; border-color: #bee5eb;}
    .alert-success {color: #167c25; background-color: #d4edda; border-color: #c3e6cb;}
    .alert-danger {color: #721c24; background-color: #f8d7da; border-color: #f5c6cb;}
    @media (max-width: 600px) {.membership-page {padding: 1rem; max-width: 100%;} .membership-grid {gap: 1rem; grid-template-columns: 1fr;} .page-header h1 {font-size: 1.3rem;}}
  </style>
</head>
<body>
  {% include "templates/includes/navbar.html" %}
{% include "templates/includes/toast.html" %}
  
<div class="membership-page">
    <header class="page-header">
      <h1>Library Membership</h1>
      <p class="membership-summary">Join our library community and access thousands of books.</p>
    </header>
    <section class="membership-list" aria-label="Membership">
      <div id="membership-grid" class="membership-grid"></div>
      <div id="message-container" class="mt-3"></div>
    </section>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // Helper function to get CSRF token
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    
    let membershipData = null;
    let isLoggedIn = false;

    function checkLoginStatus() {
      // Check if user is logged in by looking for session data in cookies
      return document.cookie.includes('sid=') || document.cookie.includes('user_id=');
    }

    $(document).ready(function() {
      isLoggedIn = checkLoginStatus();
      if (!isLoggedIn) {
        showLoginMessage();
        return;
      }
      loadMembershipStatus();
    });

    function showLoginMessage() {
      const html = `
        <div class="card membership-card mb-3">
          <div class="card-body text-center">
            <div class="alert alert-info mb-0">
              <h5 class="h6">Login Required</h5>
              <p class="mb-3">Please log in to view your membership status and join the library.</p>
              <a href="/login" class="btn btn-primary btn-sm">Login</a>
              <a href="/signup" class="btn btn-outline-secondary btn-sm ms-2">Sign Up</a>
            </div>
          </div>
        </div>
      `;
      $('#membership-grid').html(html);
    }

    function loadMembershipStatus() {
      // Use fetch API instead of frappe.call
      fetch('/api/method/library_management.api.get_membership_status', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Frappe-CSRF-Token': getCookie('csrf_token') || '{{ frappe.session.csrf_token }}'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.message && data.message.success) {
          membershipData = data.message;
          displayMembershipCards();
        } else {
          showError('Error loading membership status.');
        }
      })
      .catch(error => {
        showError('Error loading membership status.');
        console.error('Error loading membership status:', error);
      });
    }

    function displayMembershipCards() {
      let gridHtml = '';

      // No memberships: show status + join card
      if (!membershipData.has_membership || !membershipData.memberships.length) {
        gridHtml += getMembershipStatusCard('none');
        gridHtml += getJoinMembershipCard();
      } else {
        // active = any membership whose to_date >= now
        const now = new Date();
        const activeMemberships = membershipData.memberships.filter(m => new Date(m.to_date) >= now);
        const expiredMemberships = membershipData.memberships.filter(m => new Date(m.to_date) < now);

        if (activeMemberships.length > 0) {
          gridHtml += getMembershipStatusCard('active', activeMemberships, expiredMemberships);
          // Don't show join
        } else {
          gridHtml += getMembershipStatusCard('expired', [], expiredMemberships);
          gridHtml += getJoinMembershipCard();
        }
      }

      $('#membership-grid').html(gridHtml);
    }

    function getMembershipStatusCard(type, active=[], expired=[]) {
      let badge = '';
      let label = '';
      let extra = '';
      let periodList = '';
      if (type === 'none') {
        badge = `<span class="status-badge expired">No Membership</span>`;
        label = `<p class="mt-2 text-muted">You do not have a membership yet.</p>`;
      } else if (type === 'active') {
        badge = `<span class="status-badge">Active</span>`;
        label = `<p class="mt-2">You currently have an active membership.</p>`;
        // Show just dates
        if (active.length) {
          periodList += `<div class="membership-item"><strong>Valid:</strong> ${formatPeriod(active[0])}</div>`;
        }
        // If there's expired too, show it below with a heading
        if (expired.length) {
          extra += `<div class="divider"></div><div class="small text-muted mb-1">Previous Memberships</div>`;
          expired.forEach(m => {
            extra += `<div class="membership-item"><strong>Expired:</strong> ${formatPeriod(m)}</div>`;
          });
        }
      } else if (type === 'expired') {
        badge = `<span class="status-badge expired">Expired</span>`;
        label = `<p class="mt-2">Your membership has expired. Please join again!</p>`;
        // Only show last expired membership period
        if (expired.length) {
          periodList += `<div class="membership-item"><strong>Ended:</strong> ${formatPeriod(expired[0])}</div>`;
        }
        if (expired.length > 1) {
          extra += `<div class="divider"></div><div class="small text-muted mb-1">Previous Memberships</div>`;
          expired.slice(1).forEach(m => {
            extra += `<div class="membership-item"><strong>Ended:</strong> ${formatPeriod(m)}</div>`;
          });
        }
      }

      return `
        <div class="card membership-card shadow-sm" id="membership-status-card">
          <div class="card-header">
            <h4 class="h6 mb-0">Your Membership Status</h4>
          </div>
          <div class="card-body p-3 text-center">
            ${badge}
            ${label}
            ${periodList}
            ${extra}
          </div>
        </div>
      `;
    }

    function formatPeriod(m) {
      const fromDate = new Date(m.from_date).toLocaleDateString();
      const toDate = new Date(m.to_date).toLocaleDateString();
      return `${fromDate} &mdash; ${toDate}`;
    }

    function getJoinMembershipCard() {
      return `
        <div class="card membership-card shadow-sm" id="join-membership-card">
          <div class="card-header">
            <h4 class="h6 mb-0">Join Membership</h4>
          </div>
          <div class="card-body p-3">
            <div class="mb-3">
              <h5 class="h6 mb-1 text-primary">Benefits</h5>
              <ul class="mb-0">
                <li>Access to thousands of books</li>
                <li>Online reservation system</li>
                <li>Extended borrowing periods</li>
                <li>Priority access to new releases</li>
                <li>Reading clubs and events</li>
              </ul>
            </div>
            <hr class="divider">
            <div class="py-2 text-center">
              <h3 class="h6 mb-1 text-success">Free</h3>
              <p class="text-muted mb-2" style="font-size:0.96rem;">One Year Membership</p>
              <button class="btn btn-primary w-100 btn-sm py-1 px-1" id="join-membership-btn" onclick="joinMembership()" style="font-size:0.99rem;">Join Now</button>
            </div>
          </div>
        </div>
      `;
    }

    function showSuccess(message) {
      const html = `
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <strong>Success:</strong> ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      $('#message-container').html(html);
      setTimeout(() => $('.alert').fadeOut(), 5000);
    }

    function showError(message) {
      const html = `
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <strong>Error:</strong> ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      $('#message-container').html(html);
      setTimeout(() => $('.alert').fadeOut(), 5000);
    }

    function joinMembership() {
      if (!isLoggedIn) { showError('Please log in to join membership.'); return; }

      const btn = $('#join-membership-btn');
      const originalText = btn.text();
      btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Joining...');

      // Use fetch API instead of frappe.call
      fetch('/api/method/library_management.api.join_membership', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Frappe-CSRF-Token': getCookie('csrf_token') || '{{ frappe.session.csrf_token }}'
        }
      })
      .then(response => response.json())
      .then(data => {
        btn.prop('disabled', false).text(originalText);
        if (data.message && data.message.success) {
          showSuccess(data.message.message);
          setTimeout(loadMembershipStatus, 800);
        } else {
          showError(data.message?.message || 'Failed to join membership.');
        }
      })
      .catch(error => {
        btn.prop('disabled', false).text(originalText);
        showError('Error joining membership.');
        console.error('Error joining membership:', error);
      });
    }
  </script>
</body>
</html>
