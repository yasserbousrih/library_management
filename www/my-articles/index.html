<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="csrf-token" content="{{ frappe.session.csrf_token }}" />
  <title>My Articles | Library Management</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"/>
  {% include "templates/includes/design-system.html" %}
  <style>
    /* My Articles Page - Modern Design */
    .my-articles-main { 
      max-width: 1000px; 
      margin: 0 auto; 
      padding: var(--space-16) var(--space-6); 
    }
    
    .my-articles-header {
      text-align: center;
      margin-bottom: var(--space-12);
      padding: var(--space-8) 0;
    }
    
    .my-articles-title { 
      font-size: var(--font-size-4xl);
      font-weight: 800;
      color: var(--neutral-900);
      margin-bottom: var(--space-4);
      line-height: 1.2;
    }
    
    .my-articles-subtitle { 
      font-size: var(--font-size-lg);
      color: var(--neutral-600);
      margin-bottom: var(--space-8);
    }
    
    .articles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: var(--space-8);
      margin-bottom: var(--space-12);
    }
    
    .article-card {
      background: white;
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      transition: all var(--transition-normal);
      position: relative;
      border: 1px solid var(--neutral-200);
    }
    
    .article-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
    }
    
    .article-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
    }
    
    .article-card-header {
      padding: var(--space-6);
      text-align: center;
      background: var(--neutral-50);
      border-bottom: 1px solid var(--neutral-200);
    }
    
    .article-card-title {
      font-size: var(--font-size-xl);
      font-weight: 700;
      color: var(--neutral-900);
      margin-bottom: var(--space-2);
      line-height: 1.3;
    }
    
    .article-card-meta {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-4);
      font-size: var(--font-size-sm);
      color: var(--neutral-600);
    }
    
    .article-card-meta span {
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }
    
    .article-card-meta i {
      color: var(--primary-600);
    }
    
    .article-card-body {
      padding: var(--space-6);
    }
    
    .article-card-info {
      margin-bottom: var(--space-6);
    }
    
    .article-card-info > div {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-bottom: var(--space-3);
      font-size: var(--font-size-sm);
      color: var(--neutral-700);
    }
    
    .article-card-info > div:last-child {
      margin-bottom: 0;
    }
    
    .article-card-info i {
      color: var(--primary-600);
      width: 16px;
      text-align: center;
    }
    
    .article-card-actions {
      display: flex;
      gap: var(--space-3);
      margin-top: var(--space-6);
    }
    
    .btn-return {
      background: linear-gradient(135deg, var(--error-500) 0%, var(--error-600) 100%);
      color: white;
      border: none;
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius-lg);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-normal);
      box-shadow: var(--shadow-sm);
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
    }
    
    .btn-return:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      background: linear-gradient(135deg, var(--error-600) 0%, var(--error-700) 100%);
    }
    
    .btn-return:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .empty-state {
      text-align: center;
      padding: var(--space-16) var(--space-8);
      background: white;
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--neutral-200);
    }
    
    .empty-state-icon {
      width: 80px;
      height: 80px;
      background: var(--neutral-100);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto var(--space-6);
      color: var(--neutral-400);
      font-size: var(--font-size-4xl);
    }
    
    .empty-state h3 {
      font-size: var(--font-size-2xl);
      font-weight: 600;
      color: var(--neutral-900);
      margin-bottom: var(--space-3);
    }
    
    .empty-state p {
      color: var(--neutral-600);
      margin-bottom: var(--space-6);
      font-size: var(--font-size-lg);
    }
    
    .btn-browse {
      background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
      color: white;
      text-decoration: none;
      padding: var(--space-4) var(--space-8);
      border-radius: var(--radius-full);
      font-weight: 600;
      transition: all var(--transition-normal);
      box-shadow: var(--shadow-md);
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .btn-browse:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-800) 100%);
      color: white;
    }
    
    .loading-state {
      text-align: center;
      padding: var(--space-16);
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--neutral-200);
      border-top: 4px solid var(--primary-600);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--space-4);
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: var(--neutral-600);
      font-size: var(--font-size-lg);
    }
    
    @media (max-width: 768px) {
      .my-articles-main {
        padding: var(--space-8) var(--space-4);
      }
      
      .my-articles-title {
        font-size: var(--font-size-3xl);
      }
      
      .articles-grid {
        grid-template-columns: 1fr;
        gap: var(--space-6);
      }
      
      .article-card-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  {% include "templates/includes/navbar.html" %}
{% include "templates/includes/toast.html" %}
  
<div class="my-articles-main">
  <div class="my-articles-header">
    <h1 class="my-articles-title">My Articles</h1>
    <p class="my-articles-subtitle">Articles you have currently rented</p>
  </div>
  
  <!-- Loading state -->
  <div id="loading-state" class="loading-state">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading your articles...</div>
  </div>
  
  <!-- Articles list container -->
  <div id="articles-container" style="display: none;">
    <div id="articles-list" class="articles-grid"></div>
  </div>
  
  <!-- Empty state -->
  <div id="empty-state" class="empty-state" style="display: none;">
    <div class="empty-state-icon">
      <i class="bi bi-journal-bookmark"></i>
    </div>
    <h3>No Articles Rented</h3>
    <p>You haven't rented any articles yet. Browse our collection to find something interesting!</p>
    <a href="/articles-page" class="btn-browse">
      <i class="bi bi-search"></i>
      Browse Articles
    </a>
  </div>
  
  <!-- Back button -->
  <div style="text-align: center; margin-top: var(--space-8);">
    <a href="/home" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Home
    </a>
  </div>
</div>

<script>
let librarySettings = null;

// Load library settings
async function loadLibrarySettings() {
    try {
        console.log('üîç DEBUG: Loading library settings...');
        const response = await fetch('/api/method/library_management.api.get_library_settings');
        const result = await response.json();
        
        if (result.message && result.message.success) {
            librarySettings = result.message;
            console.log('üîç DEBUG: Library settings loaded:', librarySettings);
        } else {
            console.log('üîç DEBUG: Using default library settings');
            librarySettings = {
                loan_period: 14,
                max_articles_per_user: 3
            };
        }
    } catch (error) {
        console.error('üîç DEBUG: Error loading library settings:', error);
        librarySettings = {
            loan_period: 14,
            max_articles_per_user: 3
        };
    }
}

// Get CSRF token from cookies
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

async function getCSRFToken() {
    // Try to get CSRF token from the page's global variable
    if (window.frappe && window.frappe.csrf_token) {
        console.log('üîç DEBUG: Found CSRF token in window.frappe:', window.frappe.csrf_token);
        return window.frappe.csrf_token;
    }
    
    // Try different possible cookie names for CSRF token
    const possibleNames = ['csrf_token', 'frappe.csrf_token', 'csrf-token', 'frappe_csrf_token'];
    for (const name of possibleNames) {
        const token = getCookie(name);
        if (token) {
            console.log('üîç DEBUG: Found CSRF token in cookie:', name, '=', token);
            return token;
        }
    }
    
    // If no cookie found, try to get it from meta tag
    const metaToken = document.querySelector('meta[name="csrf-token"]');
    if (metaToken) {
        console.log('üîç DEBUG: Found CSRF token in meta tag:', metaToken.content);
        return metaToken.content;
    }
    
    console.log('üîç DEBUG: No CSRF token found in cookies or meta tags');
    console.log('üîç DEBUG: Available cookies:', document.cookie);
    
    // Last resort: try to get CSRF token from a simple API call
    try {
        console.log('üîç DEBUG: Attempting to get CSRF token from API call');
        const response = await fetch('/api/method/frappe.auth.get_logged_user', {
            method: 'GET'
        });
        
        // Check if response has CSRF token in headers
        const csrfToken = response.headers.get('X-Frappe-CSRF-Token');
        if (csrfToken) {
            console.log('üîç DEBUG: Found CSRF token in API response headers:', csrfToken);
            return csrfToken;
        }
        
        // Try to get it from the response body
        const result = await response.json();
        if (result.csrf_token) {
            console.log('üîç DEBUG: Found CSRF token in API response body:', result.csrf_token);
            return result.csrf_token;
        }
        
        console.log('üîç DEBUG: No CSRF token found in API response');
        return null;
    } catch (error) {
        console.log('üîç DEBUG: Error getting CSRF token from API:', error);
        return null;
    }
}

// Load rented articles on page load
document.addEventListener('DOMContentLoaded', async function() {
    await loadLibrarySettings();
    loadRentedArticles();
});

async function loadRentedArticles() {
    console.log('üîç DEBUG: Starting loadRentedArticles()');
    try {
        console.log('üîç DEBUG: Making API call to get_rented_articles');
        const response = await fetch('/api/method/library_management.api.get_rented_articles', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-Frappe-CSRF-Token': getCookie('csrf_token')
            }
        });
        
        console.log('üîç DEBUG: API response status:', response.status);
        console.log('üîç DEBUG: API response headers:', response.headers);
        
        const result = await response.json();
        console.log('üîç DEBUG: Full API response:', result);
        
        if (result.message && result.message.success) {
            const articles = result.message.data || [];
            console.log('üîç DEBUG: Found articles:', articles);
            console.log('üîç DEBUG: Article count:', articles.length);
            
            document.getElementById('loading-state').style.display = 'none';
            console.log('üîç DEBUG: Loading state hidden');
            
            if (articles.length > 0) {
                console.log('üîç DEBUG: Displaying articles');
                displayArticles(articles);
            } else {
                console.log('üîç DEBUG: No articles found, showing empty state');
                showEmptyState();
            }
        } else {
            console.log('üîç DEBUG: API returned error:', result.message);
            document.getElementById('loading-state').style.display = 'none';
            showErrorState(result.message ? result.message.message : 'Failed to load articles');
        }
    } catch (error) {
        console.error('üîç DEBUG: Error loading rented articles:', error);
        document.getElementById('loading-state').style.display = 'none';
        showErrorState('Network error. Please refresh the page.');
    }
}

function displayArticles(articles) {
    console.log('üîç DEBUG: displayArticles called with:', articles);
    const container = document.getElementById('articles-container');
    console.log('üîç DEBUG: Container element:', container);
    container.style.display = 'block';
    
    const listDiv = document.createElement('div');
    listDiv.className = 'articles-grid';
    console.log('üîç DEBUG: Created listDiv:', listDiv);
    
    articles.forEach((article, index) => {
        console.log(`üîç DEBUG: Processing article ${index}:`, article);
        const cardDiv = document.createElement('div');
        cardDiv.className = 'article-card';
        
        // Calculate due date (rental_date + loan period from settings)
        const rentalDate = new Date(article.rental_date);
        const dueDate = new Date(rentalDate);
        const loanPeriod = librarySettings ? librarySettings.loan_period : 14;
        dueDate.setDate(dueDate.getDate() + loanPeriod);
        
        cardDiv.innerHTML = `
            <div class="article-card-header">
                <h3 class="article-card-title">${article.title || article.article}</h3>
                <div class="article-card-meta">
                    <span><i class="bi bi-calendar"></i> Rented: ${formatDate(article.rental_date)}</span>
                </div>
            </div>
            <div class="article-card-body">
                <div class="article-card-info">
                    ${article.author ? `<div><i class="bi bi-person"></i> <strong>Author:</strong> ${article.author}</div>` : ''}
                    ${article.publisher ? `<div><i class="bi bi-building"></i> <strong>Publisher:</strong> ${article.publisher}</div>` : ''}
                    ${article.isbn ? `<div><i class="bi bi-upc-scan"></i> <strong>ISBN:</strong> ${article.isbn}</div>` : ''}
                    <div><i class="bi bi-calendar-check"></i> <strong>Due:</strong> ${formatDate(dueDate)}</div>
                </div>
                <div class="article-card-actions">
                    <a href="/article-detail?article_name=${article.article}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-eye"></i> View Details
                    </a>
                    <button onclick="returnArticle('${article.transaction_id}')" class="btn-return">
                        <i class="bi bi-arrow-return-left"></i> Return Article
                    </button>
                </div>
            </div>
        `;
        
        listDiv.appendChild(cardDiv);
    });
    
    console.log('üîç DEBUG: About to append listDiv to container');
    console.log('üîç DEBUG: listDiv children count:', listDiv.children.length);
    console.log('üîç DEBUG: Container before append:', container);
    container.appendChild(listDiv);
    console.log('üîç DEBUG: Container after append:', container);
    console.log('üîç DEBUG: Container children count:', container.children.length);
}

function showEmptyState() {
    document.getElementById('empty-state').style.display = 'block';
}

function showErrorState(message) {
    const container = document.getElementById('articles-container');
    container.style.display = 'block';
    container.innerHTML = `
    <div class="custom-alert custom-alert-warning">
            <i class="bi bi-exclamation-circle"></i> ${message}
    </div>
        <button onclick="loadRentedArticles()" class="custom-btn custom-btn-outline-primary">
            <i class="bi bi-arrow-clockwise"></i> Try Again
        </button>
    `;
}

function formatDate(date) {
    const d = new Date(date);
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return d.toLocaleDateString('en-US', options);
}


async function returnArticle(transactionId) {
    console.log('üîç DEBUG: Starting returnArticle() with transactionId:', transactionId);
    
    if (!confirm('Are you sure you want to return this article?')) {
        console.log('üîç DEBUG: User cancelled return');
        return;
    }
    
    try {
        console.log('üîç DEBUG: Creating JSON data for return request');
        const requestData = {
            transaction: transactionId
        };
        
        console.log('üîç DEBUG: Request data:', requestData);
        
        console.log('üîç DEBUG: Making API call to return_article');
        const csrfToken = await getCSRFToken();
        console.log('üîç DEBUG: Using CSRF token:', csrfToken);
        
        const headers = {
            'Content-Type': 'application/json'
        };
        
        // Only add CSRF token if we have one
        if (csrfToken && csrfToken !== 'None' && csrfToken !== '{{ frappe.session.csrf_token }}') {
            headers['X-Frappe-CSRF-Token'] = csrfToken;
            console.log('üîç DEBUG: Added CSRF token to headers');
        } else {
            console.log('üîç DEBUG: No valid CSRF token, making request without it');
        }
        
        // Use POST method with JSON data
        console.log('üîç DEBUG: Trying POST method with JSON');
        const response = await fetch('/api/method/library_management.api.return_article', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(requestData)
        });
        
        console.log('üîç DEBUG: Return API response status:', response.status);
        console.log('üîç DEBUG: Return API response headers:', response.headers);
        
        const result = await response.json();
        console.log('üîç DEBUG: Full return API response:', result);
        
        console.log('üîç DEBUG: Checking result structure:', {
            hasMessage: !!result.message,
            messageType: typeof result.message,
            messageContent: result.message,
            hasSuccess: result.message ? !!result.message.success : false,
            successValue: result.message ? result.message.success : 'N/A',
            directSuccess: result.success,
            directMessage: result.message
        });
        
        // Check both possible response formats
        if ((result.message && result.message.success === true) || result.success === true) {
            console.log('üîç DEBUG: Return successful, showing toast');
            showToast('Article returned successfully!', 'success', 3000);
            // Force reload immediately to update the UI
            setTimeout(() => { 
                console.log('üîç DEBUG: Reloading page after successful return');
                window.location.reload(); 
            }, 1000);
        } else {
            console.log('üîç DEBUG: Return failed:', result.message);
            const errorMsg = (result.message && result.message.message) ? result.message.message : 
                           (result.message && typeof result.message === 'string') ? result.message :
                           'Failed to return article.';
            showToast(errorMsg, 'error', 5000);
        }
    } catch (error) {
        console.error('üîç DEBUG: Return article error:', error);
        showToast('Network error. Please try again.', 'error', 5000);
    }
}

</script>
</body>
</html>