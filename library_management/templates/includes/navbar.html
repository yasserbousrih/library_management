<!-- Custom Navbar with Membership Option Hidden for Guests -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm border-bottom">
  <div class="container">
    <!-- Brand/Logo -->
    <a class="navbar-brand d-flex align-items-center" href="/home">
      <i class="bi bi-book text-primary me-2"></i>
      <span class="fw-bold text-dark">Library Management</span>
    </a>
    
    <!-- Mobile Toggle -->
    <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    
    <!-- Navigation Items -->
    <div class="collapse navbar-collapse" id="navbarNav">
      <!-- Main Navigation -->
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link fw-medium" href="/home">
            <i class="bi bi-house me-1"></i>Home
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link fw-medium" href="/articles-page">
            <i class="bi bi-journal-bookmark me-1"></i>Browse Articles
          </a>
        </li>
        {% if frappe.session.user != 'Guest' %}
        <li class="nav-item">
          <a class="nav-link fw-medium" href="/membership">
            <i class="bi bi-person-badge me-1"></i>Membership
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link fw-medium" href="/my-articles">
            <i class="bi bi-list me-1"></i>My Articles
          </a>
        </li>
        {% endif %}
      </ul>
      
      <!-- User Section -->
      {% if frappe.session.user == 'Guest' %}
        <!-- Guest User - Login/Signup -->
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link text-muted" href="/login">
              <i class="bi bi-box-arrow-in-right me-1"></i>Log In
            </a>
          </li>
          <li class="nav-item">
            <a class="btn btn-primary text-white ms-2 px-3 py-2 rounded-pill" href="/signup">
              <i class="bi bi-person-plus me-1"></i>Sign Up
            </a>
          </li>
        </ul>
      {% else %}
        <!-- Logged In User - Account Dropdown -->
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center text-dark" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 36px; height: 36px; font-size: 16px; font-weight: 600;">
                {{ frappe.session.user[0].upper() }}
              </div>
              <span class="d-none d-md-inline fw-medium">{{ frappe.session.user }}</span>
              <i class="bi bi-chevron-down ms-2 text-muted"></i>
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow border-0" aria-labelledby="userDropdown" style="min-width: 220px;">
              <!-- User Info Header -->
              <li class="dropdown-header bg-light border-bottom">
                <div class="d-flex align-items-center">
                  <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 14px;">
                    {{ frappe.session.user[0].upper() }}
                  </div>
                  <div>
                    <div class="fw-medium text-dark">{{ frappe.session.user }}</div>
                    <small class="text-muted">Library Member</small>
                  </div>
                </div>
              </li>
              <!-- Navigation Links -->
              <li><a class="dropdown-item py-2" href="/membership"><i class="bi bi-person-badge me-2 text-primary"></i>Membership</a></li>
              <li><a class="dropdown-item py-2" href="/my-articles"><i class="bi bi-list me-2 text-info"></i>My Articles</a></li>
              <li><a class="dropdown-item py-2" href="/me"><i class="bi bi-person me-2 text-secondary"></i>My Account</a></li>
              <!-- Divider -->
              <li><hr class="dropdown-divider my-2"></li>
              <!-- System Links -->
              <li><a class="dropdown-item py-2" href="/app"><i class="bi bi-laptop me-2 text-success"></i>Switch To Desk</a></li>
              <li><a class="dropdown-item py-2 text-danger" href="/?cmd=web_logout"><i class="bi bi-box-arrow-right me-2"></i>Log out</a></li>
            </ul>
          </li>
        </ul>
      {% endif %}
    </div>
  </div>
</nav>

<!-- Design System -->
{% include_web_template "design-system" %}

<!-- Bootstrap Icons CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<!-- Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom Styles for Navbar -->
<style>
  .navbar {
    background: white !important;
    border-bottom: 1px solid var(--neutral-200) !important;
    box-shadow: var(--shadow-sm);
    backdrop-filter: blur(10px);
  }
  
  .navbar-brand {
    font-size: var(--font-size-xl);
    font-weight: 700;
    color: var(--neutral-900) !important;
    text-decoration: none;
    transition: color var(--transition-fast);
  }
  
  .navbar-brand:hover {
    color: var(--primary-600) !important;
  }
  
  .nav-link {
    color: var(--neutral-700) !important;
    font-weight: 500;
    padding: var(--space-3) var(--space-4) !important;
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
    text-decoration: none;
  }
  
  .nav-link:hover {
    color: var(--primary-600) !important;
    background: var(--primary-50);
  }
  
  .nav-link.active {
    color: var(--primary-600) !important;
    font-weight: 600;
    background: var(--primary-50);
  }
  
  .dropdown-menu {
    background: white !important;
    border: 1px solid var(--neutral-200) !important;
    box-shadow: var(--shadow-xl) !important;
    border-radius: var(--radius-xl) !important;
    padding: var(--space-2);
    opacity: 0;
    transform: translateY(-10px);
    transition: all var(--transition-normal);
    pointer-events: none;
    min-width: 220px;
  }
  
  .dropdown-menu.show {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }
  
  .dropdown-item {
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-md);
    margin: var(--space-1) 0;
    transition: all var(--transition-fast);
    color: var(--neutral-700);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }
  
  .dropdown-item:hover {
    background: var(--neutral-50);
    color: var(--neutral-900);
    transform: translateX(4px);
  }
  
  .dropdown-item i {
    width: 20px;
    text-align: center;
  }
  
  .dropdown-toggle::after {
    transition: transform var(--transition-fast);
  }
  
  .dropdown-toggle[aria-expanded="true"]::after {
    transform: rotate(180deg);
  }
  
  .avatar-sm {
    font-family: var(--font-family);
    font-weight: 600;
    background: var(--primary-600);
    color: white;
    width: 36px;
    height: 36px;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--font-size-sm);
  }
  
  .btn-primary {
    background: var(--primary-600);
    border-color: var(--primary-600);
    color: white;
    font-weight: 500;
    border-radius: var(--radius-full);
    padding: var(--space-2) var(--space-4);
  }
  
  .btn-primary:hover {
    background: var(--primary-700);
    border-color: var(--primary-700);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }
  
  @media (max-width: 991.98px) {
    .navbar-collapse {
      margin-top: var(--space-4);
      padding-top: var(--space-4);
      border-top: 1px solid var(--neutral-200);
    }
    
    .dropdown-menu {
      position: static !important;
      transform: none !important;
      box-shadow: var(--shadow-sm) !important;
      border: 1px solid var(--neutral-200) !important;
      margin-top: var(--space-2);
    }
    
    .dropdown-menu.show {
      transform: none !important;
    }
  }
</style>

<script>
// Optimized dropdown functionality
(function() {
  'use strict';
  
  let dropdownToggle = null;
  let dropdownMenu = null;
  let isOpen = false;
  let clickOutsideHandler = null;
  
  // Initialize dropdown when DOM is ready
  function initDropdown() {
    dropdownToggle = document.getElementById('userDropdown');
    if (!dropdownToggle) return;
    
    dropdownMenu = dropdownToggle.nextElementSibling;
    if (!dropdownMenu) return;
    
    // Use Bootstrap if available, otherwise use custom implementation
    if (typeof bootstrap !== 'undefined' && bootstrap.Dropdown) {
      const bsDropdown = new bootstrap.Dropdown(dropdownToggle, {
        autoClose: true,
        boundary: 'viewport'
      });
      
      // Listen for Bootstrap events
      dropdownToggle.addEventListener('show.bs.dropdown', function() {
        isOpen = true;
        dropdownToggle.setAttribute('aria-expanded', 'true');
      });
      
      dropdownToggle.addEventListener('hide.bs.dropdown', function() {
        isOpen = false;
        dropdownToggle.setAttribute('aria-expanded', 'false');
      });
    } else {
      // Custom implementation with smooth animations
      dropdownToggle.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        toggleDropdown();
      });
      
      // Handle keyboard navigation
      dropdownToggle.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleDropdown();
        } else if (e.key === 'Escape' && isOpen) {
          closeDropdown();
        }
      });
    }
    
    // Add click outside handler
    setupClickOutside();
  }
  
  function toggleDropdown() {
    if (!dropdownMenu) return;
    
    isOpen = !isOpen;
    
    if (isOpen) {
      dropdownMenu.classList.add('show');
      dropdownToggle.setAttribute('aria-expanded', 'true');
    } else {
      dropdownMenu.classList.remove('show');
      dropdownToggle.setAttribute('aria-expanded', 'false');
    }
  }
  
  function setupClickOutside() {
    if (clickOutsideHandler) {
      document.removeEventListener('click', clickOutsideHandler);
    }
    
    clickOutsideHandler = function(e) {
      if (isOpen && 
          !dropdownToggle.contains(e.target) && 
          !dropdownMenu.contains(e.target)) {
        closeDropdown();
      }
    };
    
    document.addEventListener('click', clickOutsideHandler);
  }
  
  function closeDropdown() {
    if (!isOpen || !dropdownMenu) return;
    
    isOpen = false;
    dropdownMenu.classList.remove('show');
    dropdownToggle.setAttribute('aria-expanded', 'false');
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDropdown);
  } else {
    initDropdown();
  }
  
  // Cleanup on page unload
  window.addEventListener('beforeunload', function() {
    if (clickOutsideHandler) {
      document.removeEventListener('click', clickOutsideHandler);
    }
  });
})();
</script>